// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum Role {
  ADMIN
  EDITOR
  APPROVER
  DRAFTER
}

enum DocumentStatus {
  DRAFT
  FOR_REVIEW
  APPROVED
  CHANGES_REQUESTED
  FINAL
}

enum Priority {
  RESTRICTED
  CONFIDENTIAL
  SECRET
  TOP_SECRET
}

enum WorkflowStepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users         User[]         @relation("UserDepartments")
  documents     DocumentDepartments[] @relation("DepartmentDocuments")
  workflowSteps WorkflowStep[] @relation("DepartmentWorkflowSteps")
}

model User {
  id         String   @id @default(uuid())
  username   String   @unique
  name       String
  password   String
  role       Role     @default(EDITOR)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

   departments             Department[]     @relation("UserDepartments")

    documentsCreated         Document[]         @relation("CreatedDocuments")
    documentVersionsCreated  DocumentVersion[]  @relation("CreatedVersions")
    workflowStepsAssigned    WorkflowStep[]     @relation("AssignedSteps")
    workflowStepsCompleted   WorkflowStep[]     @relation("CompletedSteps")
    comments                 Comment[]          @relation("UserComments")
    notifications            Notification[]     @relation("UserNotifications")
}

model Document {
  id                String            @id @default(uuid())
  title             String
  type              String
  currentStatus     DocumentStatus    @default(DRAFT)
  currentVersionId  String?
  lockedBy          String?
  priority          Priority          @default(RESTRICTED)
  deadline          DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  createdBy    User              @relation("CreatedDocuments", fields: [createdById], references: [id])
  createdById   String

    departments       DocumentDepartments[] @relation("DocumentDepartments")

    versions          DocumentVersion[]
    workflowInstances WorkflowInstance[]
    comments          Comment[]
    notifications     Notification[] @relation("NotificationDocument")
}

model DocumentVersion {
  id            String   @id @default(uuid())
  versionNumber Int
  fileName      String
  fileSize      Int
  mimeType      String
  filePath      String
  createdAt     DateTime @default(now())

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String

  createdBy User     @relation("CreatedVersions", fields: [createdById], references: [id])
  createdById String

  @@unique([documentId, versionNumber])
}

model WorkflowInstance {
  id              String    @id @default(uuid())
  currentStep     Int       @default(1)
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId      String

  steps           WorkflowStep[]
}

model WorkflowStep {
  id            String           @id @default(uuid())
  stepOrder     Int
  departmentId  String?
  role          Role
  status        WorkflowStepStatus @default(PENDING)
  completedAt   DateTime?
  comment       String?
  completedById String?

  workflowInstance  WorkflowInstance @relation(fields: [workflowInstanceId], references: [id], onDelete: Cascade)
  workflowInstanceId String

  assignedTo       User?             @relation("AssignedSteps", fields: [assignedToId], references: [id])
  assignedToId      String?

  completedBy       User?             @relation("CompletedSteps", fields: [completedById], references: [id])

  department        Department?       @relation("DepartmentWorkflowSteps", fields: [departmentId], references: [id])
}

model Comment {
  id        String   @id @default(uuid())
  text      String
  createdAt DateTime @default(now())

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String

  author     User     @relation("UserComments", fields: [authorId], references: [id])
  authorId   String
}

model DocumentDepartments {
  id            String      @id @default(uuid())
  document      Document    @relation("DocumentDepartments", fields: [documentId], references: [id], onDelete: Cascade)
  documentId    String
  department    Department  @relation("DepartmentDocuments", fields: [departmentId], references: [id], onDelete: Cascade)
  departmentId  String

  @@unique([documentId, departmentId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String
  message   String
  documentId String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  document  Document? @relation("NotificationDocument", fields: [documentId], references: [id])
}
